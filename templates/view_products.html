<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $("#search-box").on("keyup", function() {
                var searchText = $(this).val().toLowerCase();
                $(".product-row").each(function() {
                    var productName = $(this).find(".product-name").text().toLowerCase();
                    if (productName.includes(searchText)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            $(".delete-button").click(function(e) {
                e.preventDefault();
                var productId = $(this).data("product-id");
                if (confirm("Are you sure you want to delete this product?")) {
                    $.ajax({
                        url: "{{ url_for('delete_product') }}",
                        type: "POST",
                        data: { product_id: productId },
                        success: function(response) {
                            if (response.success) {
                                showFlashMessage("Product deleted successfully", "success");
                                window.location.reload(); 
                            } else {
                                showFlashMessage("Failed to delete product: " + response.error, "error");
                            }
                        },
                        error: function(xhr, status, error) {
                            showFlashMessage("Failed to delete product", "error");
                        }
                    });
                }
            });
        });

        function showFlashMessage(message, category) {
            var flashMessage = $('<div class="flash-' + category + '">' + message + '</div>');
            $('body').append(flashMessage);
            flashMessage.show();
            setTimeout(function() {
                flashMessage.fadeOut(1000, function() {
                    flashMessage.remove();
                });
            }, 2000);
        }
    </script>
    <style>
        .flash-success {
            color: green;
            padding: 10px;
            margin: 10px 0;
            display: none;
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
        .flash-error {
            color: red;
            background-color: #ffdddd;
            padding: 10px;
            margin: 10px 0;
            display: none;
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>All Products</h1>
    <div class="container">
        <input type="text" id="search-box" placeholder="Search products...">
    </div>
    <div class="table-container">
        <table>
            <tr>
                <th>Product Name</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Actions</th>
            </tr>
            {% for product in products %}
            <tr class="product-row">
                <td class="product-name">{{ product[1] }}</td>
                <td>{{ product[2] }}</td>
                <td>{{ product[3] }}</td>
                <td>
                    <a class="edit-button" href="{{ url_for('edit_product', product_id=product[0]) }}">
                        <i class="fas fa-pencil-alt"></i> Edit
                    </a> â”‚
                    <a class="delete-button" href="#" data-product-id="{{ product[0] }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </a>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
    <div class="button-group">
        <a href="{{ url_for('dashboard') }}">Back</a>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    <script>
        window.onload = function() {
            var flashMessages = document.querySelectorAll('.flash-success, .flash-error');
            flashMessages.forEach(function(message) {
                message.style.display = 'block';
                setTimeout(function() {
                    message.style.display = 'none';
                }, 2000);
            });
        };
    </script>
</body>
</html>